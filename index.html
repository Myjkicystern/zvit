<!doctype html>
<html lang="uk">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Облік зарплати</title>
<meta name="theme-color" content="#0f172a">
<style>
  :root{font-family:Inter,Segoe UI,Roboto,Arial,sans-serif;color:#0f172a}
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;padding:0;background:#f1f5f9}
  .app{max-width:720px;margin:0 auto;padding:12px;position:relative}
  header{position:sticky;top:0;background:linear-gradient(180deg,#0f172a,rgba(15,23,42,0.95));color:#fff;padding:14px;border-radius:10px;margin-bottom:10px;z-index:10}
  header h1{font-size:18px;margin:0 0 6px}
  .balance-row{display:flex;align-items:center;gap:8px}
  .balance{font-size:20px;font-weight:700}
  .muted{opacity:.9;font-size:13px}
  .tabs{display:flex;gap:8px;margin-bottom:10px}
  .tab{flex:1;text-align:center;padding:8px 0;border-radius:10px;background:#e2e8f0;color:#0f172a;font-weight:700;cursor:pointer}
  .tab.active{background:#0f172a;color:#fff}
  .card{background:#fff;border-radius:12px;padding:12px;box-shadow:0 6px 18px rgba(2,6,23,.06)}
  form{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  label{display:block;font-size:13px;color:#334155}
  input[type="date"], input[type="number"], select, input[type="text"], input[type="password"]{width:100%;padding:12px;border-radius:10px;border:1px solid #e2e8f0;font-size:15px}
  .full{grid-column:1 / -1}
  .actions{display:flex;gap:8px;align-items:center;justify-content:center}
  button {padding:8px 16px;font-size:15px;border-radius:8px;box-shadow:0 2px 5px rgba(0,0,0,0.15);transition:transform 0.1s, box-shadow 0.1s;cursor:pointer;}
  button:hover {transform:translateY(-2px);box-shadow:0 4px 10px rgba(0,0,0,0.2);}
  .btn-primary { background: #0f172a; color: #fff; }
  .btn-ghost { background: #fff; border: 1px solid #0f172a; color: #0f172a; }
  table{width:100%;border-collapse:collapse;margin-top:12px;font-size:14px}
  thead th{text-align:left;padding:8px;color:#475569}
  tbody td{padding:10px;border-top:1px solid #f1f5f9}
  .badge{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:700;font-size:13px}
  .earned{background:#e0f2fe;color:#075985}
  .credit{background:#ecfdf5;color:#065f46}
  .debit{background:#fff7ed;color:#92400e}
  .table-wrap{overflow:auto;max-height:46vh}
  .small{font-size:13px;color:#64748b}
  #loginScreen{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;text-align:center;padding:20px}
  #loginScreen input{margin-bottom:10px;width:80%;max-width:300px}
  footer{position:fixed;bottom:8px;width:100%;text-align:center;font-size:13px;color:rgba(15,23,42,0.5);font-weight:600;pointer-events:none;transition:0.3s;opacity:0.7}
  footer:hover{opacity:1}
  @media (max-width:520px){form{grid-template-columns:1fr} header{border-radius:0} .app{padding:10px} .balance{font-size:18px}}
</style>
</head>
<body>
<div id="loginScreen">
  <h2>Вхід у систему</h2>
  <input type="password" id="passwordInput" placeholder="Введіть пароль або створіть новий">
  <button id="loginBtn" class="btn-primary">Увійти</button>
</div>

<div class="app" id="mainApp" style="display:none">
  <header>
    <h1>Облік зарплати на LiMaSoTrans.</h1>
    <div class="balance-row">
      <div class="balance">Залишок: <span id="balance">0.00</span> UAH</div>
    </div>
    <div class="small muted">Баланс = Зароблено − Нарахування − Списання • Працює офлайн</div>
  </header>

  <div class="tabs">
    <div class="tab active" id="tabTx">Транзакції</div>
    <div class="tab" id="tabStats">Статистика</div>
    <div class="tab" id="tabSettings">Налаштування</div>
  </div>

  <div id="txContent">
    <div class="card">
      <label>Авто-списання (щомісяця обраного дня)</label>
      <input type="number" id="autoDebitDay" min="1" max="31" placeholder="День місяця (1-31)" style="width:48%;display:inline-block">
      <input type="number" id="autoDebitAmount" step="0.01" min="0" placeholder="Сума UAH" style="width:48%;display:inline-block">
      <input type="text" id="autoDebitNote" placeholder="Опис для авто-списання" style="width:100%;margin-top:5px;margin-bottom:10px">
      <div class="small muted" style="margin-bottom:10px">
        Авто-списання відбувається автоматично щомісяця у вибраний день. Пропущені місяці будуть списані при наступному вході.
      </div>

      <form id="txForm">
        <label>Дата<input id="date" type="date" required></label>
        <label>Тип<select id="type">
          <option value="earned">Зароблено</option>
          <option value="credit">Нарахування</option>
          <option value="debit">Списання</option>
        </select></label>
        <label>Сума (UAH)<input id="amount" type="number" step="0.01" min="0" required></label>
        <label>Опис<input id="note" type="text" placeholder="Наприклад: зарплата, аванс, штраф"></label>
        <div class="full actions">
          <button id="addBtn" type="submit" class="btn-primary">Додати запис</button>
          <button id="clearBtn" type="button" class="btn-ghost">Очистити всі</button>
        </div>
      </form>

      <div class="table-wrap">
        <table id="txTable">
          <thead><tr><th>Дата</th><th>Тип</th><th>Сума</th><th>Опис</th><th></th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="statsContent" style="display:none">
    <div class="card">
      <h2>Статистика по місяцях</h2>
      <div class="table-wrap">
        <table id="statsTable">
          <thead><tr><th>Місяць</th><th>Зароблено</th><th>Нарахування</th><th>Списання</th><th>Баланс</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <canvas id="statsChart" style="width:100%;max-height:300px;margin-top:12px"></canvas>
    </div>
  </div>

  <div id="settingsContent" style="display:none">
    <div class="card">
      <h2>Налаштування</h2>
      <label>Старий пароль<input id="oldPass" type="password" placeholder="Введіть старий пароль"></label>
      <label>Новий пароль<input id="newPass" type="password" placeholder="Введіть новий пароль"></label>
      <div class="full actions">
        <button id="changePassBtn" class="btn-primary">Змінити пароль</button>
        <button id="logoutBtn" class="btn-ghost">Вийти</button>
      </div>
    </div>
  </div>

  <footer>Автор: Андрій Мочурад</footer>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const STORAGE_KEY='payroll_manual_single_person_pwa_v9';
const PASS_KEY='payroll_pass';
const AUTO_KEY='auto_debit';
const LAST_AUTO_KEY='last_auto_debit';

const loginScreen=document.getElementById('loginScreen');
const mainApp=document.getElementById('mainApp');
const loginBtn=document.getElementById('loginBtn');
const passwordInput=document.getElementById('passwordInput');

loginBtn.addEventListener('click',()=>{
  const inputPass=passwordInput.value.trim();
  if(!inputPass)return alert('Введіть пароль');
  const savedPass=localStorage.getItem(PASS_KEY);
  if(!savedPass){
    localStorage.setItem(PASS_KEY,inputPass);
    alert('Пароль створено!');
    loginScreen.style.display='none'; mainApp.style.display='block'; initApp();
  } else if(savedPass===inputPass){
    loginScreen.style.display='none'; mainApp.style.display='block'; initApp();
  } else {alert('Невірний пароль');}
});

function initApp(){
  const dateEl=document.getElementById('date');
  const typeEl=document.getElementById('type');
  const amountEl=document.getElementById('amount');
  const noteEl=document.getElementById('note');
  const txTableBody=document.querySelector('#txTable tbody');
  const balanceEl=document.getElementById('balance');
  const clearBtn=document.getElementById('clearBtn');
  const tabTx=document.getElementById('tabTx');
  const tabStats=document.getElementById('tabStats');
  const tabSettings=document.getElementById('tabSettings');
  const txContent=document.getElementById('txContent');
  const statsContent=document.getElementById('statsContent');
  const settingsContent=document.getElementById('settingsContent');
  const statsTableBody=document.querySelector('#statsTable tbody');
  const statsChartEl=document.getElementById('statsChart');
  const oldPass=document.getElementById('oldPass');
  const newPass=document.getElementById('newPass');
  const autoDayEl=document.getElementById('autoDebitDay');
  const autoAmtEl=document.getElementById('autoDebitAmount');
  const autoNoteEl=document.getElementById('autoDebitNote');
  const logoutBtn=document.getElementById('logoutBtn');
  let transactions=[]; let statsChart;

  function load(){
    const raw=localStorage.getItem(STORAGE_KEY); 
    if(raw){try{transactions=JSON.parse(raw);}catch(e){transactions=[];}}
    dateEl.value=new Date().toISOString().slice(0,10); 
    const auto=localStorage.getItem(AUTO_KEY);
    if(auto){const a=JSON.parse(auto); autoDayEl.value=a.day; autoAmtEl.value=a.amount; autoNoteEl.value=a.note;}
    applyAutoDebit();
    render();
  }
  function save(){localStorage.setItem(STORAGE_KEY,JSON.stringify(transactions));}
  function computeBalance(){let e=0,c=0,d=0;for(const t of transactions){const a=Number(t.amount);if(t.type==='earned')e+=a;else if(t.type==='credit')c+=a;else d+=a;}return e-c-d;}
  function escapeHtml(s){return s.replace(/[&<>'"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));}

  function render(){
    renderTransactions(); renderStats();
    balanceEl.textContent=computeBalance().toFixed(2);
  }

  function renderTransactions(){
    txTableBody.innerHTML='';
    const sorted=[...transactions].sort((a,b)=>b.date.localeCompare(a.date));
    for(const t of sorted){
      const tr=document.createElement('tr');
      const dt=new Date(t.date).toLocaleDateString();
      const label=t.type==='earned'?'Зароблено':t.type==='credit'?'Нарахування':'Списання';
      const cls=t.type==='earned'?'earned':t.type==='credit'?'credit':'debit';
      const sign=t.type==='earned'?'+':'-';
      tr.innerHTML=`<td>${dt}</td><td><span class='badge ${cls}'>${label}</span></td><td>${sign} ${Number(t.amount).toFixed(2)} UAH</td><td>${escapeHtml(t.note||'')}</td><td><button data-id='${t.id}' class='del btn-ghost'>Видалити</button></td>`;
      txTableBody.appendChild(tr);
    }
  }

  function renderStats(){
    const stats={};
    for(const t of transactions){
      const m=t.date.slice(0,7);
      if(!stats[m])stats[m]={earned:0,credit:0,debit:0};
      stats[m][t.type]+=Number(t.amount);
    }
    statsTableBody.innerHTML='';
    const labels=Object.keys(stats).sort();
    const earnedData=[],creditData=[],debitData=[];
    for(const m of labels){
      const e=stats[m].earned,c=stats[m].credit,d=stats[m].debit,b=e-c-d;
      earnedData.push(e); creditData.push(c); debitData.push(d);
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${m}</td><td>${e.toFixed(2)}</td><td>${c.toFixed(2)}</td><td>${d.toFixed(2)}</td><td>${b.toFixed(2)}</td>`;
      statsTableBody.appendChild(tr);
    }
    if(statsChart){statsChart.destroy();}
    statsChart=new Chart(statsChartEl,{
      type:'bar',
      data:{labels:labels,datasets:[
        {label:'Зароблено',data:earnedData,backgroundColor:'#075985'},
        {label:'Нарахування',data:creditData,backgroundColor:'#065f46'},
        {label:'Списання',data:debitData,backgroundColor:'#92400e'}
      ]},
      options:{responsive:true,plugins:{legend:{position:'top'}},scales:{y:{beginAtZero:true}}}
    });
  }

  document.getElementById('txForm').addEventListener('submit',(e)=>{
    e.preventDefault();
    const date=dateEl.value,type=typeEl.value,amount=parseFloat(amountEl.value),note=noteEl.value.trim();
    if(!date||isNaN(amount)||amount<=0)return;
    const tx={id:'tx_'+Date.now(),date,type,amount:amount.toFixed(2),note};
    transactions.push(tx); save(); render();
    amountEl.value=''; noteEl.value='';
  });

  txTableBody.addEventListener('click',(e)=>{
    if(e.target.classList.contains('del')){
      const id=e.target.dataset.id;
      if(confirm('Видалити запис?')){
        transactions=transactions.filter(t=>t.id!==id); save(); render();
      }
    }
  });

  clearBtn.addEventListener('click',()=>{if(confirm('Очистити всі дані?')){transactions=[];save();render();}});

  // Вкладки
  tabTx.addEventListener('click',()=>{txContent.style.display='block';statsContent.style.display='none';settingsContent.style.display='none';tabTx.classList.add('active');tabStats.classList.remove('active');tabSettings.classList.remove('active');});
  tabStats.addEventListener('click',()=>{txContent.style.display='none';statsContent.style.display='block';settingsContent.style.display='none';tabTx.classList.remove('active');tabStats.classList.add('active');tabSettings.classList.remove('active');});
  tabSettings.addEventListener('click',()=>{txContent.style.display='none';statsContent.style.display='none';settingsContent.style.display='block';tabTx.classList.remove('active');tabStats.classList.remove('active');tabSettings.classList.add('active');});

  // Пароль
  document.getElementById('changePassBtn').addEventListener('click',()=>{
    const oldVal=oldPass.value.trim(), newVal=newPass.value.trim();
    if(!oldVal||!newVal)return alert('Заповніть обидва поля');
    const saved=localStorage.getItem(PASS_KEY);
    if(saved!==oldVal)return alert('Невірний старий пароль');
    localStorage.setItem(PASS_KEY,newVal); alert('Пароль змінено'); oldPass.value=''; newPass.value='';
  });

  logoutBtn.addEventListener('click',()=>{mainApp.style.display='none';loginScreen.style.display='flex';passwordInput.value='';});

  // Авто-списання
  function saveAuto(){
    localStorage.setItem(AUTO_KEY,JSON.stringify({
      day:autoDayEl.value,
      amount:autoAmtEl.value,
      note:autoNoteEl.value.trim()
    }));
    applyAutoDebit();
    render();
  }
  [autoDayEl, autoAmtEl, autoNoteEl].forEach(el=>el.addEventListener('change',saveAuto));

  function applyAutoDebit(){
    const auto=localStorage.getItem(AUTO_KEY); if(!auto)return;
    const { day, amount, note }=JSON.parse(auto); if(!day||!amount)return;
    let lastStr=localStorage.getItem(LAST_AUTO_KEY); let lastDate=lastStr?new Date(lastStr):null;
    const today=new Date();
    let startMonth = lastDate?new Date(lastDate.getFullYear(), lastDate.getMonth(), 1): new Date(today.getFullYear(), today.getMonth(), 1);
    const monthsToApply=[];

    for(let d=new Date(startMonth); d<=new Date(today.getFullYear(), today.getMonth(), 1); d.setMonth(d.getMonth()+1)){
      monthsToApply.push(new Date(d.getFullYear(), d.getMonth(), 1));
    }

    monthsToApply.forEach(m=>{
      const txDate=new Date(m.getFullYear(), m.getMonth(), day);
      if(txDate>today)return;
      const exists=transactions.some(t=>t.type==='debit'&&t.note===note&&t.date===txDate.toISOString().slice(0,10));
      if(!exists){
        transactions.push({
          id:'tx_'+Date.now()+Math.random(),
          date:txDate.toISOString().slice(0,10),
          type:'debit',
          amount:parseFloat(amount).toFixed(2),
          note: note||'Авто-списання'
        });
      }
    });
    save();
    localStorage.setItem(LAST_AUTO_KEY, new Date().toISOString());
  }

  load();
}
</script>
</body>
</html>
