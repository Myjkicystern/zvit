<!doctype html>
<html lang="uk">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Облік зарплати</title>
<meta name="theme-color" content="#0ea5e9">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root{--primary:#0ea5e9;--primary-dark:#0369a1;--secondary:#7dd3fc;--bg:#f0f9ff;--text:#0f172a;--muted:#64748b;--card:#fff;}
*{box-sizing:border-box}
html,body{margin:0;padding:0;height:100%;background:var(--bg);font-family:Inter,Segoe UI,Roboto,Arial,sans-serif;color:var(--text);}
.app{max-width:480px;margin:0 auto;padding:8px;position:relative;}
header{position:sticky;top:0;background:linear-gradient(180deg,var(--primary-dark),rgba(14,165,233,0.95));color:#fff;padding:12px;border-radius:10px;margin-bottom:8px;z-index:10;}
header h1{font-size:16px;margin:0 0 4px;}
.balance-row{display:flex;align-items:center;gap:4px;}
.balance{font-size:18px;font-weight:700;}
.muted{opacity:.9;font-size:12px;}
.tabs{display:flex;gap:4px;margin-bottom:8px;justify-content:space-around;}
.tab{flex:1;text-align:center;padding:6px 0;border-radius:10px;background:#e2e8f0;color:var(--text);font-weight:700;cursor:pointer;}
.tab.active{background:var(--primary-dark);color:#fff;}
.card{background:var(--card);border-radius:12px;padding:8px;box-shadow:0 4px 12px rgba(2,6,23,.06);margin-bottom:8px;transition:all 0.3s;}
form{display:grid;grid-template-columns:1fr 1fr;gap:6px;}
label{display:block;font-size:12px;color:#334155;}
input[type="date"], input[type="number"], select, input[type="text"], input[type="password"]{width:100%;padding:10px;border-radius:8px;border:1px solid #e2e8f0;font-size:14px;}
.full{grid-column:1 / -1;}
.actions{display:flex;gap:6px;align-items:center;justify-content:center;flex-wrap:wrap;}
button{padding:6px;display:flex;align-items:center;justify-content:center;font-size:14px;border-radius:8px;box-shadow:0 2px 5px rgba(0,0,0,0.15);transition:transform 0.1s, box-shadow 0.1s;cursor:pointer;border:none;width:36px;height:36px;}
button:hover{transform:translateY(-1px);box-shadow:0 3px 8px rgba(0,0,0,0.2);}
.btn-primary{background:var(--primary-dark);color:#fff;}
.btn-ghost{background:#fff;border:1px solid var(--primary-dark);color:var(--primary-dark);}
.btn-danger{background:#dc2626;color:#fff;}
.icon-btn i{pointer-events:none;}
.small{font-size:11px;color:var(--muted);}
#loginScreen{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;text-align:center;padding:16px;}
#loginScreen input{margin-bottom:8px;width:80%;max-width:260px;}
footer{position:fixed;bottom:4px;width:100%;text-align:center;font-size:12px;color:rgba(15,23,42,0.5);font-weight:600;pointer-events:none;transition:0.3s;opacity:0.7;}
footer:hover{opacity:1;}
.tx-cards{display:flex;flex-direction:column;gap:6px;max-height:45vh;overflow-y:auto;transition:all 0.3s;}
.tx-card{padding:8px;border-radius:10px;box-shadow:0 1px 4px rgba(0,0,0,0.1);background:var(--card);display:flex;flex-direction:column;transition:all 0.3s;font-size:13px;}
.tx-card .top{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;}
.tx-card .top .date{font-size:12px;color:var(--muted);}
.tx-card .top .amount{font-weight:700;font-size:14px;}
.tx-card .type-badge{display:inline-block;padding:3px 6px;border-radius:999px;font-size:11px;font-weight:600;color:#fff;margin-bottom:2px;}
.type-earned{background:#0369a1;}
.type-credit{background:#0ea5e9;}
.type-debit{background:#7c2d12;}
.tx-card .note{font-size:12px;color:#334155;}
.tx-collapse-body{display:grid;transition:all 0.3s;}
#statsContent .card { max-height:55vh; overflow-y: auto; padding: -5px;}
#statsTable { font-size:10px; width:100%; border-collapse: collapse;}
#statsTable th, #statsTable td { padding:2px 4px; border:1px solid #e2e8f0; }
#statsChart { max-height:130px !important; width:100%; }
</style>
</head>
<body>
<div id="loginScreen">
  <h2>Вхід у систему</h2>
  <input type="password" id="passwordInput" placeholder="Введіть пароль">
  <button id="loginBtn" class="btn-primary"><i class="fa fa-right-to-bracket"></i></button>
</div>

<div class="app" id="mainApp" style="display:none">
  <header>
    <h1>Облік зарплати на LiMaSo_Trans</h1>
    <div class="balance-row">
      <div class="balance">Залишок: <span id="balance">0.00</span> UAH</div>
    </div>
    <div class="small muted">Баланс = Зароблено − Нарахування − Списання</div>
  </header>

  <div class="tabs">
    <div class="tab active" id="tabTx"><i class="fa fa-list"></i></div>
    <div class="tab" id="tabAuto"><i class="fa fa-repeat"></i></div>
    <div class="tab" id="tabStats"><i class="fa fa-chart-bar"></i></div>
    <div class="tab" id="tabSettings"><i class="fa fa-cog"></i></div>
  </div>

  <!-- TRANSACTIONS -->
  <div id="txContent">
    <div class="card">
      <div id="txCollapseHeader" style="cursor:pointer"><i class="fa fa-chevron-down"></i> Додати транзакцію</div>
      <div id="txFormContainer" class="tx-collapse-body">
        <form id="txForm">
          <label>Дата<input id="date" type="date" required></label>
          <label>Тип<select id="type"><option value="earned">Зароблено</option><option value="credit">Нарахування</option><option value="debit">Списання</option></select></label>
          <label>Сума<input id="amount" type="number" step="0.01" min="0" required></label>
          <label>Комісія<input id="commission" type="number" step="0.01" min="0" value="0"></label>
          <label>Опис<input id="note" type="text" placeholder="Наприклад: зарплата"></label>
          <div class="full actions">
            <button id="addBtn" class="btn-primary"><i class="fa fa-plus"></i></button>
            <button id="clearBtn" class="btn-danger"><i class="fa fa-trash"></i></button>
          </div>
        </form>
      </div>
      <div class="tx-cards"></div>
    </div>
  </div>

  <!-- AUTO DEBIT -->
  <div id="autoContent" style="display:none">
    <div class="card">
      <h2>Авто-списання</h2>
      <label>День<input type="number" id="autoDebitDay" min="1" max="31"></label>
      <label>Сума<input type="number" id="autoDebitAmount" step="0.01" min="0"></label>
      <label>Опис<input type="text" id="autoDebitNote"></label>
      <div class="actions">
        <button id="saveAutoBtn" class="btn-primary"><i class="fa fa-save"></i></button>
      </div>
      <div id="autoSavedMsg" class="small muted" style="opacity:0;transition:0.3s">Збережено</div>
    </div>
  </div>

  <!-- STATISTICS -->
  <div id="statsContent" style="display:none">
    <div class="card">
      <h2>Статистика</h2>
      <table id="statsTable">
        <thead><tr><th>Місяць</th><th>Зароблено</th><th>Нарахування</th><th>Списання</th><th>Баланс</th><th>Комісія</th></tr></thead>
        <tbody></tbody>
      </table>
      <canvas id="statsChart"></canvas>
    </div>
  </div>

  <!-- SETTINGS -->
  <div id="settingsContent" style="display:none">
    <div class="card">
      <h2>Налаштування</h2>
      <label>Старий пароль<input id="oldPass" type="password"></label>
      <label>Новий пароль<input id="newPass" type="password"></label>
      <div class="actions full">
        <button id="changePassBtn" class="btn-primary"><i class="fa fa-key"></i></button>
        <button id="logoutBtn" class="btn-ghost"><i class="fa fa-right-from-bracket"></i></button>
        <button id="resetAllBtn" class="btn-danger"><i class="fa fa-ban"></i></button>
      </div>
    </div>
  </div>

  <footer>Автор: Андрій Мочурад</footer>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const STORAGE_KEY='payroll_manual_single_person_pwa_v9';
const PASS_KEY='payroll_pass';
const AUTO_KEY='auto_debit';
const LAST_AUTO_KEY='last_auto';

const loginScreen=document.getElementById('loginScreen');
const mainApp=document.getElementById('mainApp');
const loginBtn=document.getElementById('loginBtn');
const passwordInput=document.getElementById('passwordInput');

loginBtn.addEventListener('click',()=>{
  const inputPass=passwordInput.value.trim();
  if(!inputPass)return alert('Введіть пароль');
  const savedPass=localStorage.getItem(PASS_KEY);
  if(!savedPass){
    localStorage.setItem(PASS_KEY,inputPass);
    alert('Пароль створено!');
    loginScreen.style.display='none';
    mainApp.style.display='block';
    initApp();
  } else if(savedPass===inputPass){
    loginScreen.style.display='none';
    mainApp.style.display='block';
    initApp();
  } else {alert('Невірний пароль');}
});

function initApp(){
const dateEl=document.getElementById('date');
const typeEl=document.getElementById('type');
const amountEl=document.getElementById('amount');
const noteEl=document.getElementById('note');
const commissionEl=document.getElementById('commission');
const txCards=document.querySelector('.tx-cards');
const balanceEl=document.getElementById('balance');
const clearBtn=document.getElementById('clearBtn');
const addBtn=document.getElementById('addBtn');

const tabTx=document.getElementById('tabTx');
const tabAuto=document.getElementById('tabAuto');
const tabStats=document.getElementById('tabStats');
const tabSettings=document.getElementById('tabSettings');

const txContent=document.getElementById('txContent');
const autoContent=document.getElementById('autoContent');
const statsContent=document.getElementById('statsContent');
const settingsContent=document.getElementById('settingsContent');

const statsTableBody=document.querySelector('#statsTable tbody');
const statsChartEl=document.getElementById('statsChart');

const changePassBtn=document.getElementById('changePassBtn');
const logoutBtn=document.getElementById('logoutBtn');
const oldPass=document.getElementById('oldPass');
const newPass=document.getElementById('newPass');
const resetAllBtn=document.getElementById('resetAllBtn');

const autoDayEl=document.getElementById('autoDebitDay');
const autoAmountEl=document.getElementById('autoDebitAmount');
const autoNoteEl=document.getElementById('autoDebitNote');
const saveAutoBtn=document.getElementById('saveAutoBtn');
const autoSavedMsg=document.getElementById('autoSavedMsg');

const txCollapseHeader=document.getElementById('txCollapseHeader');
const txFormContainer=document.getElementById('txFormContainer');

let transactions=[];
let statsChart;

// --- Загрузка даних ---
function load(){
  const raw=localStorage.getItem(STORAGE_KEY);
  if(raw){try{transactions=JSON.parse(raw);}catch(e){transactions=[];}}
  const autoData=JSON.parse(localStorage.getItem(AUTO_KEY)||'{}');
  autoDayEl.value=autoData.day||'';
  autoAmountEl.value=autoData.amount||'';
  autoNoteEl.value=autoData.note||'';
  runAutoDebit();
  dateEl.value=new Date().toISOString().slice(0,10);
  render();
}

// --- Збереження ---
function save(){localStorage.setItem(STORAGE_KEY,JSON.stringify(transactions));}

// --- Обчислення балансу ---
function computeBalance(){
  let e=0,c=0,d=0,com=0;
  for(const t of transactions){
    const a=Number(t.amount),cm=Number(t.commission||0);
    if(t.type==='earned') e+=a;
    else if(t.type==='credit') c+=a;
    else d+=a;
    com+=cm;
  }
  return {balance:e-c-d,totalCommission:com};
}

// --- HTML escape ---
function escapeHtml(s){return s.replace(/[&<>'"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));}

// --- Рендер ---
function render(){
  renderTransactions();
  renderStats();
  const {balance}=computeBalance();
  balanceEl.textContent=balance.toFixed(2);
  localStorage.setItem(AUTO_KEY,JSON.stringify({day:autoDayEl.value,amount:autoAmountEl.value,note:autoNoteEl.value}));
}

// --- Транзакції ---
function renderTransactions(){
  txCards.innerHTML='';
  const sorted=[...transactions].sort((a,b)=>b.date.localeCompare(a.date));
  for(const t of sorted){
    const card=document.createElement('div');
    card.className='tx-card';
    const dt=new Date(t.date).toLocaleDateString();
    const label=t.type==='earned'?'Зароблено':t.type==='credit'?'Нарахування':'Списання';
    const cls=t.type==='earned'?'type-earned':t.type==='credit'?'type-credit':'type-debit';
    const sign=t.type==='earned'?'+':'-';
    card.innerHTML=`
      <div class="type-badge ${cls}">${label}</div>
      <div class="top"><div class="date">${dt}</div><div class="amount">${sign} ${Number(t.amount).toFixed(2)} UAH</div></div>
      <div class="note">${escapeHtml(t.note||'')}</div>
      <div class="note small">Комісія: ${Number(t.commission||0).toFixed(2)} UAH</div>
      <div class="actions">
        <button class="del btn-danger" data-id="${t.id}" title="Видалити"><i class="fa fa-trash"></i></button>
        <button class="edit btn-primary" data-id="${t.id}" title="Редагувати"><i class="fa fa-edit"></i></button>
      </div>
    `;
    txCards.appendChild(card);
  }
}

// --- Статистика ---
function renderStats(){
  statsTableBody.innerHTML='';
  const monthly={};
  for(const t of transactions){
    const m=t.date.slice(0,7);
    if(!monthly[m]) monthly[m]={earned:0,credit:0,debit:0,commission:0};
    monthly[m][t.type]+=(Number(t.amount)||0);
    monthly[m].commission+=Number(t.commission||0);
  }
  const months=Object.keys(monthly).sort();
  const chartLabels=[],chartData=[];
  for(const m of months){
    const d=monthly[m];
    const bal=d.earned-d.credit-d.debit;
    chartLabels.push(m);
    chartData.push(bal);
    statsTableBody.innerHTML+=`<tr>
      <td>${m}</td>
      <td>${d.earned.toFixed(2)}</td>
      <td>${d.credit.toFixed(2)}</td>
      <td>${d.debit.toFixed(2)}</td>
      <td>${bal.toFixed(2)}</td>
      <td>${d.commission.toFixed(2)}</td>
    </tr>`;
  }
  if(statsChart) statsChart.destroy();
  statsChart=new Chart(statsChartEl,{type:'bar',data:{labels:chartLabels,datasets:[{label:'Баланс',data:chartData,backgroundColor:'#0ea5e9'}]},options:{responsive:true,plugins:{legend:{display:false}}}});
}

// --- Додати транзакцію ---
addBtn.addEventListener('click',e=>{
  e.preventDefault();
  const t={id:Date.now(),date:dateEl.value,type:typeEl.value,amount:Number(amountEl.value),note:noteEl.value,commission:Number(commissionEl.value||0)};
  transactions.push(t);
  save();
  render();
  document.getElementById('txForm').reset();
  dateEl.value=new Date().toISOString().slice(0,10);
});

// --- Очистити форму ---
clearBtn.addEventListener('click',e=>{e.preventDefault();document.getElementById('txForm').reset();dateEl.value=new Date().toISOString().slice(0,10);});

// --- Видалення та редагування ---
txCards.addEventListener('click',e=>{
  const delBtn=e.target.closest('.del');
  const editBtn=e.target.closest('.edit');
  if(delBtn){
    const id=Number(delBtn.dataset.id);
    transactions=transactions.filter(t=>t.id!==id);
    save();render();
  } else if(editBtn){
    const id=Number(editBtn.dataset.id);
    const t=transactions.find(x=>x.id===id);
    if(t){dateEl.value=t.date;typeEl.value=t.type;amountEl.value=t.amount;noteEl.value=t.note;commissionEl.value=t.commission;
      transactions=transactions.filter(x=>x.id!==id);render();}
  }
});

// --- Авто-списання ---
function runAutoDebit(){
  const day=Number(autoDayEl.value);
  const amount=Number(autoAmountEl.value);
  if(!day||!amount)return;
  const today=new Date();
  if(today.getDate()!==day)return;
  const last=Number(localStorage.getItem(LAST_AUTO_KEY)||0);
  const todayStr=today.toISOString().slice(0,10);
  if(last===todayStr)return;
  transactions.push({id:Date.now(),date:todayStr,type:'debit',amount:amount,note:autoNoteEl.value||'Авто-списання',commission:0});
  localStorage.setItem(LAST_AUTO_KEY,todayStr);
  save();
}

// --- Збереження авто-списання ---
saveAutoBtn.addEventListener('click',()=>{
  localStorage.setItem(AUTO_KEY,JSON.stringify({day:autoDayEl.value,amount:autoAmountEl.value,note:autoNoteEl.value}));
  autoSavedMsg.style.opacity=1;
  setTimeout(()=>autoSavedMsg.style.opacity=0,1000);
  runAutoDebit();render();
});

// --- Вкладки ---
[tabTx,tabAuto,tabStats,tabSettings].forEach(t=>{
  t.addEventListener('click',()=>{
    [tabTx,tabAuto,tabStats,tabSettings].forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    txContent.style.display=t===tabTx?'block':'none';
    autoContent.style.display=t===tabAuto?'block':'none';
    statsContent.style.display=t===tabStats?'block':'none';
    settingsContent.style.display=t===tabSettings?'block':'none';
  });
});

// --- Зміна пароля ---
changePassBtn.addEventListener('click',()=>{
  const oldp=oldPass.value.trim();
  const newp=newPass.value.trim();
  const saved=localStorage.getItem(PASS_KEY);
  if(oldp!==saved)return alert('Старий пароль невірний');
  if(!newp)return alert('Введіть новий пароль');
  localStorage.setItem(PASS_KEY,newp);
  alert('Пароль змінено');oldPass.value='';newPass.value='';
});

// --- Вихід ---
logoutBtn.addEventListener('click',()=>{mainApp.style.display='none';loginScreen.style.display='flex';passwordInput.value='';});

// --- Скидання всіх даних ---
resetAllBtn.addEventListener('click',()=>{if(confirm('Ви дійсно хочете видалити всі дані?')){localStorage.removeItem(STORAGE_KEY);transactions=[];render();}});

// --- Згортання форми ---
txCollapseHeader.addEventListener('click',()=>{if(txFormContainer.style.display==='none'||txFormContainer.style.display===''){txFormContainer.style.display='grid';} else txFormContainer.style.display='none';});

// --- Початкове завантаження ---
load();
}
</script>
</body>
</html>
